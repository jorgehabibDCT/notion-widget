<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dashboards ‚Ä¢ Rotator</title>
<style>
  :root{
    --bg:#0b0c10; --panel:#111318; --ink:#eef2ff; --muted:#a5adcb; --accent:#4f7cff; --border:#222631;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg); color:var(--ink); font-family:ui-sans-serif,system-ui,Arial}
  header{padding:16px 18px;border-bottom:1px solid var(--border); display:flex; align-items:center; gap:12px; position:sticky; top:0; background:var(--bg); z-index:5}
  header h1{font-size:18px; margin:0; font-weight:700}
  .spacer{flex:1}
  .badge{font-size:12px;color:var(--muted)}
  main{display:grid; place-items:center; padding:14px}
  .frame{width:min(980px,96vw); background:var(--panel); border:1px solid var(--border); border-radius:16px; overflow:hidden; position:relative}
  .hero{position:relative; aspect-ratio:16/9; background:#0e1017; display:grid; place-items:center}
  .hero img{width:100%; height:100%; object-fit:cover; display:block; opacity:0; transition:opacity .25s ease}
  .hero img.loaded{opacity:1}
  .overlay{
    position:absolute; inset:auto 0 0 0; padding:14px 16px; display:flex; gap:8px; align-items:center;
    background:linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,.55) 45%, rgba(0,0,0,.7) 100%);
  }
  .flags{margin-left:auto; display:flex; gap:8px}
  .flag{border:1px solid rgba(255,255,255,.2); background:rgba(0,0,0,.35); backdrop-filter: blur(6px);
        border-radius:10px; padding:6px 8px; cursor:pointer; user-select:none; font-size:14px}
  .flag.active{outline:2px solid var(--accent)}
  .content{padding:18px 18px 22px; display:flex; gap:18px; align-items:flex-start; flex-wrap:wrap}
  .script{font:600 13px/1.3 ui-monospace,SFMono-Regular,Consolas,Monaco,monospace; color:var(--muted); background:#0c0f16; border:1px solid var(--border); padding:6px 8px; border-radius:8px}
  .title{font-size:22px; font-weight:800; margin:2px 0 6px}
  .desc{font-size:15px; color:var(--muted)}
  .controls{
    position:absolute; inset:0; display:flex; align-items:center; justify-content:space-between; pointer-events:none;
  }
  .ctrl{
    pointer-events:auto; cursor:pointer; border:1px solid var(--border); background:rgba(0,0,0,.45);
    color:#fff; width:40px; height:40px; display:grid; place-items:center; border-radius:999px; margin:0 10px;
  }
  .dots{position:absolute; bottom:10px; left:0; right:0; display:flex; gap:6px; justify-content:center}
  .dot{width:8px; height:8px; border-radius:999px; background:rgba(255,255,255,.28); cursor:pointer}
  .dot.active{background:#fff}
  .bar{position:absolute; left:0; bottom:0; height:3px; background:var(--accent); width:0%}
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  a.link{color:#8ab4ff; text-decoration:none}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
</style>
</head>
<body>
<header>
  <h1>Dashboards</h1>
  <span class="badge" id="counter">‚Äî</span>
  <div class="spacer"></div>
  <button id="playpause" class="flag" title="Pause/Play">‚è∏</button>
</header>

<main>
  <div class="frame" id="frame" aria-live="polite">
    <div class="hero" id="hero">
      <img id="heroImg" alt="">
      <div class="controls">
        <button class="ctrl" id="prev" aria-label="Previous">‚Äπ</button>
        <button class="ctrl" id="next" aria-label="Next">‚Ä∫</button>
      </div>
      <div class="dots" id="dots"></div>
      <div class="bar" id="bar"></div>
      <div class="overlay">
        <div class="flags" id="flags"></div>
      </div>
    </div>

    <div class="content">
      <div class="row">
        <code class="script" id="scriptTag"></code>
      </div>
      <div>
        <div class="title" id="title"></div>
        <div class="desc" id="desc"></div>
      </div>
    </div>
  </div>
</main>

<script>
/*** CONFIG ***/
const FEED_URL =
  "https://feed-proxy.jorge-habib.workers.dev/?url=" +
  encodeURIComponent("https://cdn.pegasusgateway.com/pegasus/dashboards_resources.json");

// Language order + flag
const LANGS = [
  { code:"es", label:"Espa√±ol", flag:"üá≤üáΩ" }, // default first for you
  { code:"en", label:"English", flag:"üá∫üá∏" },
  { code:"pt", label:"Portugu√™s", flag:"üáßüá∑" },
  { code:"fr", label:"Fran√ßais", flag:"üá´üá∑" },
  { code:"cs", label:"ƒåe≈°tina", flag:"üá®üáø" },
  { code:"pl", label:"Polski",  flag:"üáµüá±" }
];

const AUTOPLAY_MS = 6500;

/*** STATE ***/
const state = {
  items: [],
  i: 0,
  lang: localStorage.getItem("dash_lang") || LANGS[0].code,
  playing: true,
  timer: null,
  progressTimer: null,
  progress: 0
};

/*** EL REFS ***/
const heroImg   = document.getElementById("heroImg");
const titleEl   = document.getElementById("title");
const descEl    = document.getElementById("desc");
const scriptTag = document.getElementById("scriptTag");
const flagsEl   = document.getElementById("flags");
const dotsEl    = document.getElementById("dots");
const barEl     = document.getElementById("bar");
const counterEl = document.getElementById("counter");
const playBtn   = document.getElementById("playpause");

/*** HELPERS ***/
const $ = (s)=>document.querySelector(s);
const esc = s => String(s ?? "");
function setPlaying(v){
  state.playing = v;
  playBtn.textContent = v ? "‚è∏" : "‚ñ∂";
  if (v) startAutoplay(); else stopAutoplay();
}
function next(){ goTo((state.i + 1) % state.items.length); }
function prev(){ goTo((state.i - 1 + state.items.length) % state.items.length); }
function goTo(n){
  state.i = n;
  state.progress = 0;
  render();
}
function startAutoplay(){
  stopAutoplay();
  state.timer = setInterval(next, AUTOPLAY_MS);
  state.progressTimer = setInterval(()=>{
    state.progress += 100/(AUTOPLAY_MS/50);
    if (state.progress>100) state.progress=0;
    barEl.style.width = state.progress + "%";
  }, 50);
}
function stopAutoplay(){
  clearInterval(state.timer); clearInterval(state.progressTimer);
  state.timer = null; state.progressTimer=null; barEl.style.width="0%";
}
function onHoverPause(bindEl){
  bindEl.addEventListener("mouseenter", ()=>setPlaying(false));
  bindEl.addEventListener("mouseleave", ()=>setPlaying(true));
}
function currentLangObj(){ return LANGS.find(l=>l.code===state.lang) || LANGS[0]; }

/*** RENDER ***/
function render(){
  const it = state.items[state.i]; if (!it) return;

  // image
  heroImg.classList.remove("loaded");
  heroImg.src = it.image || "";
  heroImg.alt = it.title_i18n?.[state.lang] || it.script || "dashboard";
  heroImg.onload = ()=>heroImg.classList.add("loaded");

  // text
  const langTitle = it.title_i18n?.[state.lang] || fallbackFirst(it.title_i18n) || it.script;
  const langDesc  = it.desc_i18n?.[state.lang]  || fallbackFirst(it.desc_i18n)  || "";
  titleEl.textContent = langTitle;
  descEl.textContent  = langDesc;
  scriptTag.textContent = it.script;

  // flags
  flagsEl.innerHTML = LANGS.map(l =>
    `<button class="flag ${l.code===state.lang?'active':''}" data-lang="${l.code}" title="${l.label}">${l.flag}</button>`
  ).join("");

  // dots
  dotsEl.innerHTML = state.items.map((_,idx)=>`<div class="dot ${idx===state.i?'active':''}" data-idx="${idx}"></div>`).join("");

  counterEl.textContent = ` ${state.i+1} / ${state.items.length}`;
  localStorage.setItem("dash_lang", state.lang);
}

function fallbackFirst(obj){
  if (!obj) return "";
  const firstKey = Object.keys(obj)[0];
  return obj[firstKey] || "";
}

/*** EVENTS ***/
document.getElementById("next").addEventListener("click", ()=>{ next(); });
document.getElementById("prev").addEventListener("click", ()=>{ prev(); });
dotsEl.addEventListener("click", (e)=>{
  const dot = e.target.closest(".dot"); if (!dot) return;
  const idx = Number(dot.getAttribute("data-idx"));
  goTo(idx);
});
flagsEl.addEventListener("click", (e)=>{
  const b = e.target.closest(".flag"); if (!b) return;
  state.lang = b.getAttribute("data-lang");
  render();
});
playBtn.addEventListener("click", ()=> setPlaying(!state.playing));
onHoverPause(document.getElementById("frame"));
document.addEventListener("keydown", (e)=>{
  if (e.key==="ArrowRight") next();
  if (e.key==="ArrowLeft")  prev();
  if (e.key===" ") { e.preventDefault(); setPlaying(!state.playing); }
});

/*** LOAD ***/
async function start(){
  const res = await fetch(FEED_URL, {mode:"cors"});
  const json = await res.json();

  // Accept either {dashboards:[...]} or top-level array
  const items = Array.isArray(json) ? json
    : Array.isArray(json.dashboards) ? json.dashboards
    : [];

  // Minimal validation and sort by script for deterministic order
  state.items = items
    .filter(d => d && d.script)
    .sort((a,b)=>String(a.script).localeCompare(String(b.script)));

  render();
  setPlaying(true);
}

start().catch(err=>{
  titleEl.textContent = "Failed to load dashboards";
  descEl.textContent = esc(err.message);
});
</script>
</body>
</html>
